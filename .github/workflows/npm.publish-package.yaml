name: Publish an NPM Package

on:
  workflow_call:
    inputs:
      working-directory:
        description: Directory with the NPM package contnts
        type: string
        default: ./
        required: false
      build-command:
        description: Command to perform NPM pack
        type: string
        required: true
      ref:
        description: 'ref or tag to publish NPM package from'
        type: string
        required: false
      node-version:
        description: Node Version
        type: string
        default: 16.x
        required: false

    secrets:
      token:
        description: NPM token
        required: true

    outputs:
      package-name:
        description: Package name from package.json
        value: ${{ jobs.publish.outputs.package-name }}
      published:
        description: Indicates whether an NPM package has been published
        value: ${{ jobs.publish.outputs.published }}

jobs:
  publish:
    name: Build NPM package
    runs-on: ubuntu-latest
    outputs:
      package-name: ${{ steps.info.outputs.name }}
      published: ${{ steps.status.outputs.published }}

    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ inputs.ref }}
      -
        uses: actions/setup-node@v2
        with:
          node-version: ${{ inputs.node-version }}
          registry-url: 'https://registry.npmjs.org'
      -
        name: Package info
        id: info
        uses: gregoranders/nodejs-project-info@v0.0.12
        with:
          path: ${{ inputs.working-directory }}/package.json
      -
        name: Build package
        id: build
        working-directory: ${{ inputs.working-directory }}
        run: |
          ${{ inputs.build-command }}
      -
        name: Publish to npmjs.com
        working-directory: ${{ inputs.working-directory }}
        run: |
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.token }}
      -
        name: Publish status
        if: always()
        id: status
        run: echo '::set-output name=published::${{ job.status == 'success' }}'
