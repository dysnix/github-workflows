name: Build and Push
on:
  workflow_call:
    inputs:
      registry:
        description: Docker registry to login
        required: true
        type: string
      username:
        description: Docker registry username
        required: false
        type: string
      repository:
        description: Docker repository name (ex. eu.gcr.io/project)
        required: false
        type: string
      gcloud-auth:
        description: Use gcloud CLI authentication helper (gcloud auth configure-docker)
        required: false
        type: boolean
      image:
        description: Docker image name (ex. organization/repo)
        required: false
        type: string
      autolatest:
        description: Automatically add latest tag (for the latest semver, aka v1.2.3)
        required: false
        type: boolean
      push-on-tags:
        description: Push the image on a tag push
        required: false
        default: true
        type: boolean
      push:
        description: Specifies whether to push the image (not viable with push-on-tags==true)
        required: false
        type: boolean
      build-args:
        description: "List of build-time variables"
        required: false
        type: string
      context:
        description: "Build's context is the set of files located in the specified PATH or URL"
        required: false
        type: string
      file:
        description: "Path to the Dockerfile"
        required: false
        type: string
      labels:
        description: "List of metadata for an image"
        required: false
        type: string
      tags:
        description: "List of tags"
        required: false
        type: string
    secrets:
      password:
        description: Docker registry password
        required: false

jobs:
  pre:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.set.outputs.image }}
    steps:
      -
        uses: actions/github-script@v4
        id: set
        with:
          script: |-
            const imageRepo = '${{ github.event.repository.owner.login }}'.toLowerCase().replace(/\/docker-/, '/')
            const imageName = '${{ github.event.repository.name }}'.toLowerCase().replace(/\/docker-/, '/')

            let imagePaths = [
              '${{ inputs.repository }}' == '' ? imageRepo : '${{ inputs.repository }}',
              '${{ inputs.image }}' == '' ? imageName : '${{ inputs.image }}',
            ]

            // combine full image path
            core.setOutput('image', imagePaths.join('/'))

            // autoset username for GCR
            if ( '${{ inputs.registry }}'.endsWith('.gcr.io') ) {
              core.setOutput('username', '_json_key')
            } else {
              core.setOutput('username', '${{ inputs.username }}')
            }

  build:
    name: Build and Push
    runs-on: ubuntu-latest
    needs: [pre]

    steps:
      - uses: actions/checkout@v2
      -
        if: autolatest == 'true'
        id: latest
        uses: dysnix/find-latest-tag@v1
        with:
          regex: '^v\d'
          compared-to-tag: ${{ github.ref }}
          repository: ${{ github.repository }}
      -
        name: Docker meta
        id: meta
        uses: docker/metadata-action@v3
        with:
          images: ${{ needs.pre.outputs.image }}
          flavor: |
            latest=${{ steps.latest.outputs.newer == 'true' || steps.latest.outputs.equal == 'true' }}
          tags: |
            type=ref,event=tag
            type=ref,event=branch
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      -
        name: Cache Docker layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |-
            ${{ runner.os }}-buildx-${{ github.event.before }}
      -
        if: inputs.gcloud-auth != 'true'
        uses: docker/login-action@v1
        with:
          registry: ${{ inputs.registry }}
          username: ${{ needs.pre.outputs.username }}
          password: ${{ secrets.password }}
      -
        if: inputs.gcloud-auth == 'true'
        name: Run
        run: gcloud auth configure-docker --quiet
      -
        name: Build and push
        uses: docker/build-push-action@v2
        with:
          context: ${{ inputs.context }}
          push: ${{ inputs.push-on-tags && startsWith(github.ref, 'refs/tags/') || inputs.push }}
          file: ${{ inputs.file }}
          tags: |
            ${{ steps.meta.outputs.tags }}
            ${{ inputs.tags }}
          labels: |
            ${{ steps.meta.outputs.labels }}
            ${{ inputs.labels }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new
      -
        # Temp fix
        # https://github.com/docker/build-push-action/issues/252
        # https://github.com/moby/buildkit/issues/1896
        name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
